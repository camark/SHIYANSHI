
@{
    Layout = "~/Views/Shared/AppCreate.cshtml";
}

@using (Html.BeginForm("", "api/PREPARE_SCHEMEApi/Post"))
{
    <fieldset>
        <legend>
            <label>报告证书类别</label><input type="button" value="报告上传" class="a2 f2" onclick="shangchuan()" />
            <input type="submit" value="建立方案" class="a2 f2" />
            <input class="a2 f2" type="button" onclick="BackList('VJIANDINGRENWU')" value="返回" />
        </legend>
        <div id="xuanzhefangandiv">
            <div class="input_search">
                <div class="input_search-label">
                    报告类别:
                </div>
                @if (ViewBag.SYS == Common.LABORATORYNAME.互感器.ToString())
                {
                    <div class="input_search-field">
                        @Html.DropDownList("REPORT_CATEGORY", Models.SysFieldModels.GetSysField("VJIANDINGRENWU", "REPORT_CATEGORY_HUGANQI"), "请选择", new { id = "REPORT_CATEGORY" })
                    </div>
                }
                else if (ViewBag.SYS == Common.LABORATORYNAME.指示仪表.ToString())
                {
                    <div class="input_search-field">
                        @Html.DropDownList("REPORT_CATEGORY", Models.SysFieldModels.GetSysField("VJIANDINGRENWU", "REPORT_CATEGORY_ZHISHIYIBIAO"), "请选择", new { id = "REPORT_CATEGORY" })
                    </div>
                }
                else if (ViewBag.SYS == Common.LABORATORYNAME.数表三相.ToString() || ViewBag.SYS == Common.LABORATORYNAME.数表单相.ToString())
                {
                    <div class="input_search-field">
                        @Html.DropDownList("REPORT_CATEGORY", Models.SysFieldModels.GetSysField("VJIANDINGRENWU", "REPORT_CATEGORY_SHUZI"), "请选择", new { id = "REPORT_CATEGORY" })
                    </div>
                }
                else if (ViewBag.SYS == Common.LABORATORYNAME.直流仪器.ToString())
                {
                    <div class="input_search-field">
                        @Html.DropDownList("REPORT_CATEGORY", Models.SysFieldModels.GetSysField("VJIANDINGRENWU", "REPORT_CATEGORY_ZHILIU"), "请选择", new { id = "REPORT_CATEGORY" })
                    </div>
                }
                else if (ViewBag.SYS == Common.LABORATORYNAME.电能.ToString())
                {
                    <div class="input_search-field">
                        @Html.DropDownList("REPORT_CATEGORY", Models.SysFieldModels.GetSysField("VJIANDINGRENWU", "REPORT_CATEGORY_DIANNENG"), "请选择", new { id = "REPORT_CATEGORY" })
                    </div>
                }

            </div>
            <br style="clear:both" />
            <div class="input_search">
                <div class="input_search-label">
                    证书类别:
                </div>
                <div class="input_search-field">
                    @*onchange="zhengshuxuanzhe()*@
                    @Html.DropDownList("CERTIFICATE_CATEGORY", Models.SysFieldModels.GetSysField("VJIANDINGRENWU", "CERTIFICATE_CATEGORY"), "请选择", new { id = "CERTIFICATE_CATEGORY" })
                </div>

            </div>
            <br style="clear:both" />

            <div id="cnas" style="display:none">
                <div class="input_search-label">
                    CNAS:
                </div>

                <div class="editor-field">
                    Yes: <input type="radio" id="cnasyes" name="CNAS" onclick="zizhiget(this)" value="Yes" atps="cnasyes" />
                    No: <input type="radio" id="cnasno" name="CNAS" onclick="zizhiget(this)" value="No" atps="cnasno" />
                </div>
            </div>

            <div class="" id="jianding" style="display:none">
                <div class="input_search-label">
                    检定授权:
                </div>
                <div class="editor-field">
                    Yes: <input type="radio" id="jiandingyes" name="CERTIFICATION_AUTHORITY" onclick="zizhiget(this)" value="Yes" atps="jiandingyes" />
                    No: <input type="radio" id="jiandingno" name="CERTIFICATION_AUTHORITY" onclick="zizhiget(this)" value="No" atps="jiandingno" />
                </div>
            </div><br style="clear:both" />
            <div class="input_search" id="kongzhi" style="display:none">
                <div class="input_search-label">
                    控制编号:
                </div>
                @if (ViewBag.SYS == Common.LABORATORYNAME.互感器.ToString())
                {
                    <div class="input_search-field">
                        @Html.DropDownList("CONTROL_NUMBER", Models.SysFieldModels.GetSysField("VJIANDINGRENWU", "CONTROL_NUMBER_HUGANQI"), "请选择", new { id = "CONTROL_NUMBER" })
                    </div>
                }
                else if (ViewBag.SYS == Common.LABORATORYNAME.电能.ToString())
                {
                    <div class="input_search-field">
                        @Html.DropDownList("CONTROL_NUMBER", Models.SysFieldModels.GetSysField("VJIANDINGRENWU", "CONTROL_NUMBER_DIANNENG"), "请选择", new { id = "CONTROL_NUMBER" })
                    </div>
                }
                else if (ViewBag.SYS == Common.LABORATORYNAME.指示仪表.ToString())
                {
                    <div class="input_search-field">
                        @Html.DropDownList("CONTROL_NUMBER", Models.SysFieldModels.GetSysField("VJIANDINGRENWU", "CONTROL_NUMBER_ZHISHIYIBIAO"), "请选择", new { id = "CONTROL_NUMBER" })
                    </div>
                }
                else if (ViewBag.SYS == Common.LABORATORYNAME.数表三相.ToString() || ViewBag.SYS == Common.LABORATORYNAME.数表单相.ToString())
                {
                    <div class="input_search-field">
                        @Html.DropDownList("CONTROL_NUMBER", Models.SysFieldModels.GetSysField("VJIANDINGRENWU", "CONTROL_NUMBER_SHUZI"), "请选择", new { id = "CONTROL_NUMBER" })
                    </div>
                }
                else if (ViewBag.SYS == Common.LABORATORYNAME.直流仪器.ToString())
                {
                    <div class="input_search-field">
                        @Html.DropDownList("CONTROL_NUMBER", Models.SysFieldModels.GetSysField("VJIANDINGRENWU", "CONTROL_NUMBER_ZHILIU"), "请选择", new { id = "CONTROL_NUMBER" })
                    </div>
                }
            </div><br style="clear:both" />
            <div class="input_search">
                <div class="input_search-label">
                    资质:
                </div>
                <div class="input_search-field">
                    <select id="QUALIFICATIONS" name="QUALIFICATIONS">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>

        </div>
        <input type="hidden" value="" id="ACCEPT_ORGNIZATION_HIDDEN" />
        <input type="hidden" name="APPLIANCE_LABORATORYID" id="APPLIANCE_LABORATORYID" value="@ViewBag.APPLIANCE_LABORATORYID" />
        <input type="hidden" name="ID" id="ID_String" value="@ViewBag.Id" />
    </fieldset>
}
<script type="text/javascript">
    //报告上传非空判断
    function baogaoif(arr) {
        var zhi = "";
        if (isNull(arr.REPORT_CATEGORY)) {
            zhi += "报告类别不能为空！<br>";
        }
        if (isNull(arr.CERTIFICATE_CATEGORY)) {
            zhi += "证书类别不能为空！<br>";
        }
        else {
            if (arr.CERTIFICATE_CATEGORY == "检定") {
                if (isNull(arr.CERTIFICATION_AUTHORITY)) {
                    zhi += "检定授权不能为空！<br>";
                }
            }
            else if (arr.CERTIFICATE_CATEGORY == "校准") {
                if (isNull(arr.CNAS)) {
                    zhi += "CNAS不能为空！<br>";
                }
                else {
                    if (arr.CNAS == "Yes") {
                        if (isNull(arr.CONTROL_NUMBER)) {
                            zhi += "控制编号不能为空！<br>";
                        }
                    }
                }
            }
        }
        if (isNull(arr.CNAS)) {
            zhi += "报告类别不能为空！<br>";
            if (true) {

            }
        }
        if (isNull(arr.REPORT_CATEGORY)) {
            zhi += "报告类别不能为空！<br>";
        }
        if (zhi != "") {
            $.messager.alert('操作提示', zhi, 'info');
            return false;
        }
        else {
            return true;
        }

    }
    /*
用途：检查输入字符串是否为空或者全部都是空格
输入：str
返回：
如果全是空返回true,否则返回false
*/
    function isNull(str) {
        if (str == "") return true;
        var regu = "^[ ]+$";
        var re = new RegExp(regu);
        return re.test(str);
    }
    //报告上传
    function shangchuan() {
        var arr = {
            REPORT_CATEGORY: $("#REPORT_CATEGORY").val(),//报告类别
            CERTIFICATE_CATEGORY: $("#CERTIFICATE_CATEGORY").val(),//证书类别
            CNAS: $("input[name='CNAS']:checked").val(),//CNAS
            CERTIFICATION_AUTHORITY: $("input[name='CERTIFICATION_AUTHORITY']:checked").val(),//检定授权
            CONTROL_NUMBER: $("#CONTROL_NUMBER").val(),//控制编号
            QUALIFICATIONS: $("#QUALIFICATIONS").val(),//资质
            APPLIANCE_LABORATORYID: $("#APPLIANCE_LABORATORYID").val(),
            ID: $("#ID_String").val()
        }
        if (baogaoif(arr)) {
            $.ajax({
                url: "/api/PREPARE_SCHEMEApi/Post",
                type: "Post",
                data: arr,
                dataType: "json",

                success: function (data) {
                    if (data.Code == 0) { $.messager.alert('操作提示', data.Message, 'info'); }
                    else if (data.Code == 1) {
                        var id = "@ViewBag.Id";
                        var di = data.Id;
                        window.location.href = "/VJIANDINGRENWU/BaoGaoShangChuan/" + di + "|@ViewBag.APPLIANCE_DETAIL_INFORMATIONID";
                        return false;
                    }
                    else {
                        if ($.messager) {
                            $.messager.defaults.ok = '继续';
                            $.messager.defaults.cancel = '返回';

                            $.messager.confirm('操作提示', data.Message, function (r) {
                                if (!r) {
                                    window.location.href = 'javascript:history.go(-1)';
                                }
                            });
                        }
                    }


                }
            })
        }
    }

    //重新绑定资质
    function zizhiget(arr) {
        var zhi = $(arr).attr("atps");
        var zhi2 = $("#ACCEPT_ORGNIZATION_HIDDEN").val();
        switch (zhi) {
            case "cnasyes":
                $("#kongzhi").show();
                if (zhi2 == "华北电力科学研究院有限责任公司") {
                    getCity($("#QUALIFICATIONS"));
                    $("<option></option>")
                               .val("本实验室获中国合格评定国家认可委员（CNAS）认可证书，证书号No.L0394")
                               .text("本实验室获中国合格评定国家认可委员（CNAS）认可证书，证书号No.L0394")
                               .appendTo($("#QUALIFICATIONS"));
                }
                else if (zhi2 == "冀北电力有限公司计量中心") {
                    getCity($("#QUALIFICATIONS"));
                    $("<option></option>")
                               .val("本实验室获中国合格评定国家认可委员（CNAS）认可证书，证书号No.L0394")
                               .text("本实验室获中国合格评定国家认可委员（CNAS）认可证书，证书号No.L0394")
                               .appendTo($("#QUALIFICATIONS"));
                }
                break;
            case "cnasno":
                $("#kongzhi").hide();
                $('#CONTROL_NUMBER').val("");
                if (zhi2 == "华北电力科学研究院有限责任公司") {
                    getCity($("#QUALIFICATIONS"));
                    $("<option></option>")
                               .val("/")
                               .text("/")
                               .appendTo($("#QUALIFICATIONS"));
                }
                else if (zhi2 == "冀北电力有限公司计量中心") {
                    getCity($("#QUALIFICATIONS"));
                    $("<option></option>")
                                .val("/")
                               .text("/")
                               .appendTo($("#QUALIFICATIONS"));
                }
                break;
            case "jiandingyes":
                $("#kongzhi").hide();
                if (zhi2 == "华北电力科学研究院有限责任公司") {
                    getCity($("#QUALIFICATIONS"));
                    $("<option></option>")
                               .val("本单位获北京市质量技术监督局专项计量授权，证书编号：（京）法计（2012）006号")
                               .text("本单位获北京市质量技术监督局专项计量授权，证书编号：（京）法计（2012）006号")
                               .appendTo($("#QUALIFICATIONS"));
                }
                else if (zhi2 == "冀北电力有限公司计量中心") {
                    getCity($("#QUALIFICATIONS"));
                    $("<option></option>")
                               .val("本单位获河北市质量技术监督局专项计量授权，证书编号：（冀）法计（2014）D033号")
                               .text("本单位获河北市质量技术监督局专项计量授权，证书编号：（冀）法计（2014）D033号")
                               .appendTo($("#QUALIFICATIONS"));
                }
                break;
            case "jiandingno":
                $("#kongzhi").hide();
                if (zhi2 == "华北电力科学研究院有限责任公司") {
                    getCity($("#QUALIFICATIONS"));
                    $("<option></option>")
                               .val("/")
                               .text("/")
                               .appendTo($("#QUALIFICATIONS"));
                }
                else if (zhi2 == "冀北电力有限公司计量中心") {
                    getCity($("#QUALIFICATIONS"));
                    $("<option></option>")
                                .val("/")
                               .text("/")
                               .appendTo($("#QUALIFICATIONS"));
                }
                break;
            default:

        }
    }

    function getCity(City) {
        $(City).empty();
        $("<option></option>")
                .val("")
                .text("请选择")
                .appendTo($(City));
    }
</script>
<script type='text/javascript'>
    $(function () {
        //输入框的禁用
        if ("@ViewBag.REPORTSTATUS" == "@Common.REPORTSTATUS.审核驳回.ToString()" || "@ViewBag.REPORTSTATUS" == "@Common.REPORTSTATUS.批准驳回.ToString()" || "@ViewBag.REPORTSTATUS" == "") {
            return true;
        }
        else {
            $('#xuanzhefangandiv').find(":text,:selected,select,:radio,textarea,:checked,:password").each(function () {
                $(this).attr("disabled",true);
            });
        }
    })
    $(function () {
        //查询受理单位
        $.ajax({
            url: "/api/VAPPLIANCE_DETAIL_INFORMATIONApi/GetGetByAPPLIANCE_DETAIL_INFORMATIONId/" + "@ViewBag.APPLIANCE_DETAIL_INFORMATIONID",
            type: "Put",
            // async: false,
            success: function (res) {
                if (res != null) {
                    $("#ACCEPT_ORGNIZATION_HIDDEN").val(res);
                }
            }
        })
        if ("@ViewBag.SBL" != "") {
            var a = "@ViewBag.SBL";
            var b = a.split(',');
            for (var i = 0; i < b.length; i++) {
                var c = b[i].split('*');
                switch (c[0]) {
                    case "REPORT_CATEGORY":
                        $("#REPORT_CATEGORY").val(c[1]);//报告类别
                        break;
                    case "CONTROL_NUMBER":
                        $("#CONTROL_NUMBER").val(c[1]);//控制编号
                        break;
                    case "CERTIFICATE_CATEGORY":
                        $("#CERTIFICATE_CATEGORY").val(c[1]);//证书类别
                        if (c[1] == "检定") {
                            $("#jianding").show();
                            var ja = b[5].split('*')[1];
                            if (ja == "Yes") {
                                $("#jiandingyes").attr("checked", 'checked')
                            }
                            else if (ja[1] == "No") {
                                $("#jiandingno").attr("checked", 'checked')
                            }

                        }
                        else if (c[1] == "校准") {
                            $("#cnas").show();
                            var cb = b[6].split('*')[1];
                            if (cb == "Yes") {
                                $("#cnasyes").attr("checked", 'checked')
                                $("#kongzhi").show();
                            }
                            else if (cb[1] == "No") {
                                $("#cnasno").attr("checked", 'checked')
                            }
                        }
                        break;
                    case "QUALIFICATIONS":
                        $("<option></option>")
                         .val(c[1])
                         .text(c[1])
                         .appendTo($("#QUALIFICATIONS"));
                        $("#QUALIFICATIONS").val(c[1]);//资质
                        break;
                    default:

                }
            }
        }
        //选择证书
        $("#CERTIFICATE_CATEGORY").change(function () {
            var option = $("#CERTIFICATE_CATEGORY option:selected");
            var b = option.text();
            $("#cnasyes,#cnasno,#jiandingno,#jiandingyes").removeAttr("checked");
            if (b == "检定") {
                $("#cnas").hide();
                $("#jianding").show();
                $("#kongzhi").hide();
            }
            else if (b == "校准") {
                $("#cnas").show();
                $("#jianding").hide();
            }
            else {
                $("#cnas").hide();
                $("#jianding").hide();
            }
        });



        function ajaxFrom(form, url) {

            $.ajax({
                url: url,
                type: "Post",
                data: $(form).serialize(),
                dataType: "json",

                success: function (data) {
                    if (data.Code == 0) { $.messager.alert('操作提示', data.Message, 'info'); }
                    else if (data.Code == 1) {
                        var id = "@ViewBag.Id";
                        window.location.href = "/VJIANDINGRENWU/JianLiFangAn/" + id;
                        return false;
                    }
                    else {
                        if ($.messager) {
                            $.messager.defaults.ok = '继续';
                            $.messager.defaults.cancel = '返回';

                            $.messager.confirm('操作提示', data.Message, function (r) {
                                if (!r) {
                                    window.location.href = 'javascript:history.go(-1)';
                                }
                            });
                        }
                    }


                }
            });

        }

        $(function () {
            $('.easyui-combobox').combobox({
                width: 243,
                onSelect: function (record) {
                    var strs = record.text.split("—");
                    $(this).combobox('setValue', strs[0]);
                }
            });
            $("form").submit(function (form) {
                if (form.result) {
                    ajaxFrom(this, this.action);
                }
                return false;
            });
            //按钮样式
            $('.a2').mouseover(function () { this.style.color = "#ae1121"; }).mouseout(function () { this.style.color = "#333"; });

        })
    });
</script>